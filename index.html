<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>KMQR Generator - QR Code Creator</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="shortcut icon" href="icon.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&display=swap" rel="stylesheet">
  <style>
        .header-bar > div {
          margin-top: 50px !important;
        }
        .header-bar .button-row {
          margin-top: 0px !important;
          z-index: 0;
        }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      box-sizing: border-box;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hanuman', sans-serif;
    }
    .header-bar {
      overflow: visible;
      position: fixed;
      top: 10px;
      left: 0;
      right: 0;
      width: 100vw;
      z-index: 2000;
      height: 112px;
      min-height: 112px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border-bottom: 1px solid #64748b;
      backdrop-filter: blur(8px) saturate(180%);
      background: rgba(30,41,59,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .header-bar h1 {
      padding: 40px 0 10px 0;
      margin: 10px;
      font-size: 32px;
      font-family: 'Hanuman', 'Segoe UI', Arial, sans-serif;
      font-style: italic;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
      font-weight: 900;
      letter-spacing: 1px;
      line-height: 1.1;
      text-align: center;
      z-index: 1;
    }
    .main-wrapper {
      margin-top: 64px;
      width: 100%;
      max-width: 100vw;
    }
    .main-wrapper > .container {
      width: 100%;
      max-width: 700px;
      margin: 10px auto 18px auto;
      margin-top: 60px !important;

    }
  </style>
  <body onload="initializeWelcome()">
      <!-- Update Info Modal -->
      <div id="updateInfoModal" class="modal">
        <div class="modal-content" style="max-width: 380px; text-align: center;">
          <button class="close-btn" onclick="document.getElementById('updateInfoModal').classList.remove('active'); document.getElementById('updateInfoModal').style.display = 'none';" style="position: absolute; top: 18px; right: 18px; font-size: 36px; color: #94a3b8; background: none; border: none; cursor: pointer;">&times;</button>
          <h2 style="color: #f59e0b; font-size: 22px; font-weight: 700; margin: 0 0 18px 0;">Update Info</h2>
          <div id="updateInfoContent" style="font-size:16px;line-height:1.7;color:#e2e8f0;"></div>
        </div>
      </div>
  <!-- Update Info Modal -->
  <!-- NOTE: No <table>, <tr>, or <th> elements (header rows) exist in this file as of Jan 2026. No header rows to center. -->
  <div id="updateInfoModal" class="modal">
    <div class="modal-content" style="max-width: 380px; text-align: center;">
      <button class="close-btn" onclick="document.getElementById('updateInfoModal').classList.remove('active'); document.getElementById('updateInfoModal').style.display = 'none';" style="position: absolute; top: 18px; right: 18px; font-size: 36px; color: #94a3b8; background: none; border: none; cursor: pointer;">&times;</button>
      <h2 style="color: #f59e0b; font-size: 22px; font-weight: 700; margin: 0 0 18px 0;">Update Info</h2>
      <div id="updateInfoContent" style="font-size:16px;line-height:1.7;color:#e2e8f0;"></div>
    </div>
  </div>
  <!-- ...existing code... -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>KMQR Generator - QR Code Creator</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="shortcut icon" href="icon.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Hanuman:wght@400;700&display=swap" rel="stylesheet">
  <script>
    // SMART VERSION CHECK - Keep activation, only update code
    const KMQR_VERSION = '1.0.8';
    const versionKey = 'kmqr_version_loaded';
    const storedVersion = localStorage.getItem(versionKey);
    
    // Initialize language FIRST before any handlers
    let currentLang = localStorage.getItem('kmqr_lang') || 'km';
    
    // Version check logic continues...
    
    if (storedVersion !== KMQR_VERSION) {
      // NEW VERSION: Save activation state, clear old cache, update version
      const activationState = localStorage.getItem('kmqr_app_activated');
      const licenseCode = localStorage.getItem('kmqr_license_code');
      
      // Clear old stuff but KEEP activation
      localStorage.clear();
      
      // Restore activation state
      if (activationState) localStorage.setItem('kmqr_app_activated', activationState);
      if (licenseCode) localStorage.setItem('kmqr_license_code', licenseCode);
      
      // Update version
      localStorage.setItem(versionKey, KMQR_VERSION);
      localStorage.setItem('kmqr_welcome_shown', 'true'); // Skip welcome if already activated
      
      // Quick refresh to load new code (only once per version)
      window.location.href = window.location.href.split('?')[0] + '?v=' + KMQR_VERSION;
    }
    
    // DEBUG: Always show main UI, bypass activation/welcome modals
    window.addEventListener('DOMContentLoaded', function() {
      // Show loading screen
      var loading = document.getElementById('loadingScreen');
      if (loading) {
        loading.classList.remove('hidden');
        loading.style.display = 'flex';
      }
      // Optionally hide main UI while loading
      document.querySelectorAll('.container').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'none');
      if (document.getElementById('welcomeModal')) document.getElementById('welcomeModal').style.display = 'none';
      if (document.getElementById('licenseModal')) document.getElementById('licenseModal').style.display = 'none';
    });
    // Define handler functions EARLY so they're available for onclick handlers
    window.handleBtnEnterLicense = function() {
      console.log('handleBtnEnterLicense called');
      document.getElementById('welcomeModal').style.display = 'none';
      document.getElementById('licenseModal').classList.add('active');
      document.getElementById('licenseModal').style.display = 'flex';
    };
    
    window.handleBtnSkipTrial = function() {
      console.log('handleBtnSkipTrial called');
      localStorage.setItem('kmqr_welcome_shown', 'true');
      localStorage.setItem('kmqr_app_activated', 'false');
      document.getElementById('welcomeModal').style.display = 'none';
      document.querySelectorAll('.container').forEach(el => el.style.display = 'block');
      document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'block');
      document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'block');
      updateActivationStatus();
    };
    
    // Generate or retrieve unique device ID (offline tracking)
    function getDeviceId() {
      let deviceId = localStorage.getItem('kmqr_device_id');
      if (!deviceId) {
        // Generate a simple UUID (RFC4122 v4 compliant)
        deviceId = 'KMQR-' + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
        localStorage.setItem('kmqr_device_id', deviceId);
      }
      return deviceId;
    }

    // Show device ID in license modal
    function updateDeviceIdInfo() {
      const deviceIdDiv = document.getElementById('deviceIdInfo');
      if (deviceIdDiv) {
        const t = translations[currentLang];
        deviceIdDiv.innerHTML = '<span style="color:#f59e0b;font-size:13px;">' + t.deviceIdLabel + '</span><br><span style="font-family:monospace;font-size:15px;color:#3b82f6;">' + getDeviceId() + '</span>';
      }
    }

    window.handleBtnActivateLicense = function() {
      console.log('handleBtnActivateLicense called');
      const licenseInput = document.getElementById('licenseCodeInput');
      const licenseCode = licenseInput.value.trim();
      
      if (!licenseCode) {
        alert(translations[currentLang].alertEnterLicense);
        return;
      }
      
      if (!licenseCode.startsWith('KMQR-') && !licenseCode.startsWith('TRIAL-')) {
        alert(translations[currentLang].alertInvalidLicense);
        return;
      }
      
      localStorage.setItem('kmqr_welcome_shown', 'true');
      localStorage.setItem('kmqr_app_activated', 'true');
      localStorage.setItem('kmqr_license_code', licenseCode);
      
      document.getElementById('licenseModal').classList.remove('active');
      document.getElementById('licenseModal').style.display = 'none';
      document.getElementById('welcomeModal').style.display = 'none';
      document.querySelectorAll('.container').forEach(el => el.style.display = 'block');
      document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'block');
      document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'block');
      
      licenseInput.value = '';
      updateActivationStatus();
      updateDeviceIdInfo();
    };
    
    window.handleBtnCancelLicense = function() {
      console.log('handleBtnCancelLicense called');
      localStorage.setItem('kmqr_welcome_shown', 'true');
      localStorage.setItem('kmqr_app_activated', 'false');
      
      document.getElementById('licenseModal').classList.remove('active');
      document.getElementById('licenseModal').style.display = 'none';
      document.querySelectorAll('.container').forEach(el => el.style.display = 'block');
      document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'block');
      document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'block');
      
      const licenseInput = document.getElementById('licenseCodeInput');
      licenseInput.value = '';
      
      updateActivationStatus();
      updateDeviceIdInfo();
    };
  </script>
  <style>
                        .header-bar h1 {
                          padding-top: 18px !important;
                          padding-bottom: 10px !important;
                          margin-bottom: 0 !important;
                          margin-top: 10px !important;
                        }
                    html, body {
                      margin: 0 !important;
                      padding: 0 !important;
                      border: 0 !important;
                      height: 100%;
                      width: 100%;
                      box-sizing: border-box;
                    }
                    body > *:first-child {
                      margin-top: 0 !important;
                      padding-top: 0 !important;
                      border-top: 0 !important;
                    }
                    .header-bar {
                      position: fixed !important;
                      top: 0 !important;
                      left: 0;
                      right: 0;
                      margin: 0 auto 0 auto !important;
                      width: 100vw !important;
                      max-width: 100vw !important;
                      z-index: 2000;
                      height: 64px !important;
                      min-height: 64px !important;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
                      border-bottom: 1px solid #334155 !important;
                      backdrop-filter: blur(8px) saturate(180%) !important;
                      background: rgba(30,41,59,0.85) !important;
                    }
                    .main-wrapper {
                      margin-top: 64px !important; /* perfectly flush with header-bar, 0px gap */
                    }
                body {
                  min-height: 100vh;
                  overflow-x: hidden;
                .header-bar {
                  position: sticky;
                  top: 0;
                  left: 0;
                  right: 0;
                  width: 100vw;
                  z-index: 2000;
                  height: 64px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                  border-bottom: 1px solid #334155;
                  backdrop-filter: blur(8px) saturate(180%);
                  background: rgba(30,41,59,0.85);
                  display: flex;
                  flex-direction: column;
                  justify-content: center;
                }
                .header-bar h1 {
                  padding: 18px 0 10px 0;
                  margin: 0;
                  font-size: 32px;
                  font-family: 'Hanuman', 'Segoe UI', Arial, sans-serif;
                  font-style: italic;
                  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                  white-space: nowrap;
                  font-weight: 900;
                  letter-spacing: 1px;
                  line-height: 1.1;
                  text-align: center;
                }
                .main-wrapper {
                  width: 100%;
                  max-width: 100vw;
                }
                .main-wrapper > .container {
                  width: 100%;
                  max-width: 700px;
                  margin: 10px auto 18px auto;
		  margin-top: 50px !important;

                }
      width: 100%;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Hanuman', sans-serif;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
      transition: opacity 0.5s ease;
      opacity: 1;
      pointer-events: auto;
    }
    #loadingScreen.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    .loading-spinner {
      width: 100%;
      max-width: 700px;
      background: #1e293b;
      border-radius: 0;
      padding: 16px;
      box-shadow: none;
      position: relative;
      z-index: 100;
      border: 1px solid #334155;
      margin-left: auto;
      margin-right: auto;
      overflow: visible;
      height: auto;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #cbd5e1;
      font-size: 32px;
      font-style: italic;
      font-weight: bold;
      display: flex;
      align-items: flex-end;
      margin: 0;
      padding: 0;
      margin: 40px auto 20px auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 0 8px;
    }

    .container {
      width: 100%;
      max-width: 700px;
      background: #1e293b;
      border-radius: 0;
      padding: 16px;
      box-shadow: none;
      position: relative;
      z-index: 100;
      border: 1px solid #334155;
      margin-top: 50px !important;

      margin-left: auto;
      margin-right: auto;
    }

    .header-bar {
      background: #1e293b;
      padding: 8px 10px 4px 10px;
      position: relative;
      top: 30px;
      z-index: 101;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 700px;
      margin: 0 auto 1px auto !important;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .main-wrapper {
      display: block;
      width: 100%;
    }

    #activationStatus {
      display: none;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .section {
      background: #0f172a;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .section-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #cbd5e1;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="color"],
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #334155;
      border-radius: 6px;
      background: #1e293b;
      color: #e2e8f0;
      margin-bottom: 8px;
      font-size: 14px;
    }

    input[type="color"] {
      padding: 8px;
      cursor: pointer;
    }

    select {
      cursor: pointer;
    }

    input[type="text"]::placeholder {
      color: #64748b;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .color-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .color-row > div {
      display: flex;
      flex-direction: column;
    }

    .color-row label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
      color: #cbd5e1;
    }

    .color-row input[type="color"] {
      margin-bottom: 0;
      height: 44px;
      cursor: pointer;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      width: 100%;
      margin-top: 8px;
      pointer-events: auto;
      touch-action: manipulation;
      min-height: 38px;
    }

    button.primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      margin-top: 0 !important;
      padding-top: 0 !important;
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.25);
    }

    button.primary:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #475569, #334155);
      color: white;
      margin-top: 0;
      border: 1px solid #64748b;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    button.secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #64748b, #475569);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    }

    button.secondary:active:not(:disabled) {
      transform: translateY(0);
    }

    button.secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.ghost {
      background: transparent;
      color: #cbd5e1;
      border: 1px solid #475569;
      margin-top: 0;
      transition: all 0.2s;
    }

    button.ghost:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.05));
      color: #e2e8f0;
      border-color: #3b82f6;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.15);
      transform: translateY(-1px);
    }

    button.ghost:active {
      transform: translateY(0);
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .button-group.full {
      grid-template-columns: 1fr;
    }

    #qrPreview {
      text-align: center;
      padding: 20px;
      background: #0f172a;
      border-radius: 8px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    #qrPreview canvas {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    #qrPreview p {
      color: #64748b;
      font-size: 14px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 5000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow: auto;
      pointer-events: auto;
    }
    
    .modal > * {
      pointer-events: auto;
    }

    .modal.active {
      display: flex !important;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: #1e293b;
      padding: 24px;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-width: 700px;
      margin-bottom: 4px;
      display: flex;
      flex-direction: column;
      height: auto;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid #334155;
    }
    
    .modal-content button {
      pointer-events: auto;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .modal-content input {
      pointer-events: auto;
      touch-action: manipulation;
    }

    .modal-content h2 {
      margin-bottom: 16px;
      color: #10b981;
      font-size: 22px;
      text-align: center;
    }

    #helpContent,
    #aboutContent {
      line-height: 1.8;
      color: #cbd5e1;
      font-size: 14px;
      text-align: left;
    }

    #helpContent p,
    #aboutContent p {
      margin-bottom: 12px;
      color: #e2e8f0;
    }

    #helpContent a,
    #aboutContent a {
      color: #3b82f6;
      text-decoration: none;
      word-break: break-word;
    }

    #helpContent a:hover,
    #aboutContent a:hover {
      color: #60a5fa;
      text-decoration: underline;
    }

    #helpContent hr,
    #aboutContent hr {
      margin: 16px 0;
      border: none;
      border-top: 1px solid #475569;
    }

    .modal-content p {
      line-height: 1.8;
      margin-bottom: 12px;
      font-size: 14px;
      color: #cbd5e1;
    }

    .modal-content a {
      color: #3b82f6;
      text-decoration: none;
      word-break: break-word;
    }

    .modal-content a:hover {
      text-decoration: underline;
      color: #60a5fa;
    }

    .close-btn {
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #64748b;
      background: none;
      border: none;
      padding: 4px 8px;
      width: auto;
      margin: -8px -8px 0 0;
      line-height: 1;
      transition: color 0.2s;
      pointer-events: auto !important;
      z-index: 5002;
      position: relative;
    }

    .close-btn:hover {
      color: #ef4444;
    }
    
    .close-btn:active {
      color: #dc2626;
    }

    .logo-preview {
      margin-top: 8px;
      padding: 8px;
      background: #0f172a;
      border-radius: 4px;
      text-align: center;
      max-height: 80px;
    }

    .logo-preview img {
      max-width: 100%;
      max-height: 80px;
      border-radius: 4px;
    }

    .logo-preview p {
      color: #64748b;
      font-size: 12px;
      margin-top: 4px;
    }

    @media (max-width: 768px) {
      .container {
        display: block !important;
        width: 100%;
        max-width: 700px;
        padding: 16px;
	margin-top: 100px !important;

      }
      
      #qrPreview {
        grid-column: 1;
        grid-row: auto;
        margin-top: 20px;
      }
      
      h1 { font-size: 18px; }
      button { font-size: 12px; padding: 10px 12px; min-height: 36px; }
      input, select { font-size: 14px; padding: 10px; }
    }

    /* Mobile (< 480px) */
    @media (max-width: 480px) {
      body { padding: 4px; }
      .container { 
        max-width: 95vw; 
        margin: 10px auto; 
        padding: 12px;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      h1 { font-size: 16px; }
      .button-group { grid-template-columns: 1fr 1fr; }
      button { font-size: 11px; padding: 8px 6px; min-height: 36px; }
      input, select { font-size: 16px; padding: 12px; }
      .section { padding: 12px; overflow: visible; height: auto; }
      
      #qrPreview {
        grid-column: 1;
        grid-row: auto;
        min-height: 200px;
      }
      
      /* Mobile welcome modal */
      .modal-content {
        width: 95vw !important;
        max-width: 95vw !important;
        margin: 20px auto !important;
        padding: 16px !important;
      }
      
      .modal-content button {
        padding: 12px !important;
        font-size: 13px !important;
        min-height: 44px !important;
        width: 100% !important;
      }
    }

    /* Desktop (> 768px) */
    @media (min-width: 769px) {
      .container {
        grid-template-columns: 1fr 1fr;
        max-width: 1400px;
      }
      
      button {
        min-height: 40px;
        font-size: 14px;
        padding: 12px 18px;
      }
      
      input[type="text"],
      input[type="color"],
      select {
        font-size: 14px;
        padding: 10px 12px;
      }
      
      #qrPreview {
        min-height: 500px;
        grid-column: 2;
        grid-row: 2;
      }
    }
  </style>
</head>
<body onload="initializeWelcome()">
  <!-- Update Notification Banner -->
  <div id="updateBanner" style="display: none; background: linear-gradient(135deg, #f59e0b, #d97706); padding: 12px 16px; text-align: center; color: white; font-weight: 600; font-size: 13px; border-bottom: 1px solid #b45309; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
    ğŸ”„ New version available! <button id="updateNowBtn" style="background: white; color: #d97706; border: none; padding: 4px 12px; border-radius: 3px; font-weight: 700; cursor: pointer; margin-left: 8px; font-size: 12px;">Update Now</button>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading KMQR Generator...</div>
  </div>

  <!-- Welcome Choice Screen - First Time Only -->
  <div id="welcomeModal" style="display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 9999; padding: 40px 20px; text-align: center; overflow-y: auto;">
    <h2 id="welcomeTitle" style="color: #3b82f6; margin: 0 0 12px 0; font-size: 28px;"></h2>
    <p id="welcomeSubtitle" style="color: #cbd5e1; margin: 0 0 30px 0; font-size: 14px;"></p>
    
    <button id="btnEnterLicense" type="button" onclick="try { handleBtnEnterLicense(); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" style="display: block; width: 95%; max-width: 350px; margin: 20px auto; padding: 24px; background: #10b981; color: white; border: 2px solid #10b981; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 18px; min-height: 60px; position: relative; z-index: 10000; pointer-events: auto;"></button>
    
    <button id="btnSkipTrial" type="button" onclick="try { handleBtnSkipTrial(); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" style="display: block; width: 95%; max-width: 350px; margin: 15px auto; padding: 16px; background: transparent; color: #60a5fa; border: 2px solid #60a5fa; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; min-height: 50px; position: relative; z-index: 10000; pointer-events: auto;"></button>
    
    <p id="trialModeInfo" style="color: #64748b; font-size: 12px; margin-top: 20px;"></p>
  </div>

  <!-- License Code Activation Modal -->
  <div id="licenseModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <h2 id="licenseModalTitle" style="color: #10b981; text-align: center; margin-bottom: 20px;">ğŸ”“ á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠ</h2>
      
      <div style="background: #0f172a; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #334155;">
        <div id="deviceIdInfo" style="margin-bottom: 10px; text-align: center;"></div>
        <p id="licenseInstructions" style="font-size: 13px; color: #cbd5e1; margin-bottom: 12px;"><strong>á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠášá”áŸáŸ‹á¢áŸ’á“á€áá¶á„á€áŸ’ášáŸ„á˜áŠá¾á˜áŸ’á”á¸áŠáŸ„áŸ‡áŸáŸ„á˜á»áá„á¶ášá–áŸá‰á›áŸá‰áŸ–</strong></p>
        
        <input type="text" id="licenseCodeInput" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡..." style="width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 6px; background: #1e293b; color: #e2e8f0; font-size: 14px; margin-bottom: 12px; font-family: monospace; touch-action: manipulation; pointer-events: auto;">
        
        <p id="licenseContactInfo" style="font-size: 12px; color: #94a3b8; line-height: 1.6;">ğŸ“§ á˜á·á“á˜á¶á“á›áŸáá€á¼áŠá‘áŸ?<br>á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„áŸ– <strong>my.khem.mathst@gmail.com</strong><br>ğŸ“± á‘á¼ášáŸáŸá–áŸ’á‘áŸ– <strong>+855 66/99 931319</strong><br>ğŸ’¬ TelegramáŸ– <strong>@khemmy99</strong></p>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <button id="btnActivateLicense" type="button" onclick="try { handleBtnActivateLicense(); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" style="padding: 14px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; min-height: 50px; width: 100%; pointer-events: auto; touch-action: manipulation; -webkit-user-select: none; user-select: none;">âœ… á’áŸ’áœá¾á±áŸ’á™áŸá€á˜áŸ’á˜</button>
        <button id="btnCancelLicense" type="button" onclick="try { handleBtnCancelLicense(); } catch(e) { console.error('Error:', e); alert('Error: ' + e.message); }" style="padding: 14px; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; min-height: 50px; width: 100%; pointer-events: auto; touch-action: manipulation; -webkit-user-select: none; user-select: none;">á”áŸ„áŸ‡á”á„áŸ‹</button>
      </div>
    </div>
  </div>

  <!-- Header with Title and Buttons -->
  <div class="header-bar">
    <div style="display: flex; flex-direction: column; align-items: center; gap: 0;">
      <div style="width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <h1 id="title" style="display: flex; justify-content: center; align-items: flex-end; margin: 0 auto; font-size: 32px; font-family: 'Hanuman', 'Segoe UI', Arial, sans-serif; font-style: italic; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; font-weight: 900; letter-spacing: 1px; line-height: 1.1; text-align: center;">KMQR Generator</h1>
        <div style="border-bottom: 1.5px solid #334155; width: 100%; margin: 4px auto 0 auto;"></div>
      </div>
      <div class="button-row" style="width: 100%; display: flex; flex-direction: row; gap: 8px; justify-content: center; margin-top: 18px; margin-bottom: 8px; flex-wrap: nowrap; overflow-x: auto;">
        <button id="activateBtn" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.2s; box-shadow: 0 2px 6px rgba(16,185,129,0.25); min-height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1;" onclick="document.getElementById('helpModal').classList.remove('active'); document.getElementById('helpModal').style.display = 'none'; document.getElementById('aboutModal').classList.remove('active'); document.getElementById('aboutModal').style.display = 'none'; document.getElementById('licenseModal').classList.add('active'); document.getElementById('licenseModal').style.display = 'flex';">ğŸ”“ Activate</button>
        <button id="btnHelp2" style="background: #475569; color: #e2e8f0; border: 1px solid #64748b; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.2s; min-height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1;" onclick="document.getElementById('helpModal').classList.add('active'); document.getElementById('helpModal').style.display = 'flex'; document.getElementById('aboutModal').classList.remove('active'); document.getElementById('aboutModal').style.display = 'none'; document.getElementById('licenseModal').classList.remove('active'); document.getElementById('licenseModal').style.display = 'none';"><span style="display: flex; align-items: center; gap: 4px;"><img src="icon.png" alt="Help" style="height: 16px; width: 16px; vertical-align: middle;"> <span id="btnHelp2Text">Help</span></span></button>
        <button id="btnAbout2" style="background: #475569; color: #e2e8f0; border: 1px solid #64748b; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.2s; min-height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1;" onclick="document.getElementById('aboutModal').classList.add('active'); document.getElementById('aboutModal').style.display = 'flex'; document.getElementById('helpModal').classList.remove('active'); document.getElementById('helpModal').style.display = 'none'; document.getElementById('licenseModal').classList.remove('active'); document.getElementById('licenseModal').style.display = 'none'; (function(){var lang=localStorage.getItem('kmqr_lang')||'km';var t=window.translations&&window.translations[lang];if(t){var aboutHtml = '<div style=\'text-align:center;\'><b>'+t.title+'</b></div>';aboutHtml += '<div style=\'margin-top:8px;font-size:15px;\'><b>'+t.version+'</b><br><span>'+t.developerLabel+'</span> <span>'+t.developer+'</span></div>';document.getElementById('aboutContent').innerHTML=aboutHtml;}})();">About</button>
        <button id="langToggle" style="background: #475569; color: #e2e8f0; border: 1px solid #64748b; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.2s; min-height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1;">ğŸŒ English</button>
        <button id="updateCheckBtn" style="background: #64748b; color: #e2e8f0; border: 1px solid #94a3b8; padding: 8px 12px; border-radius: 4px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; transition: all 0.2s; min-height: 36px; display: flex; align-items: center; justify-content: center; line-height: 1;">ğŸ”„ Update</button>
      </div>
    </div>
    </div>
  </div>
  </div>
  
  <div class="main-wrapper">
    <div class="container">
      <div class="section">
        <div class="section-title" id="textLabel">á¢ááŸ’áá”á‘ á¬ URL</div>
        <input id="qrText" type="text" placeholder="á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘, URL, á¬á—á¶áŸá¶ááŸ’á˜áŸ‚ášâ€¦" />
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 12px;">
          <div>
            <label id="sizeLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1;">á‘áŸ†á áŸ†</label>
            <select id="qrSize">
              <option value="200">200</option>
              <option value="256">256</option>
              <option value="320">320</option>
              <option value="400">400</option>
            </select>
          </div>
          <div>
            <label id="ecLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1;">á€áŸ†ášá·áá€áŸ‚á€áŸ†á á»áŸ</label>
            <select id="qrEC">
              <option value="L" id="ecLow">á‘á¶á”</option>
              <option value="M" selected id="ecMedium">á˜á’áŸ’á™á˜</option>
              <option value="Q" id="ecQuartile">ááŸ’á–áŸáŸ‹</option>
              <option value="H" id="ecHigh">ááŸ’á–áŸáŸ‹á”áŸ†á•á»á</option>
            </select>
          </div>
          <div>
            <label id="dpiLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1;">á‚á»áá—á¶á– (DPI)</label>
            <select id="dpiScale">
              <option value="1">1Ã—</option>
              <option value="2" selected>2Ã—</option>
              <option value="3">3Ã—</option>
            </select>
          </div>
          <div>
            <label id="roundLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1;">ášá¼á”áŸá‰áŸ’á‰á¶á˜á¼á›</label>
            <select id="logoRound">
              <option value="no" id="no">á‘áŸ</option>
              <option value="yes" selected id="yes">á”á¶á‘/á…á¶áŸ</option>
            </select>
          </div>
        </div>
        <div class="color-row" style="margin-top: 12px; grid-template-columns: 1fr 1fr; gap: 10px; align-items: stretch;">
          <div>
            <label id="fgLabel">á–ááŸŒá˜á»á</label>
            <input id="qrFG" type="color" value="#000000" />
          </div>
          <div>
            <label id="bgLabel">á–ááŸŒáá¶á„á€áŸ’ášáŸ„á™</label>
            <input id="qrBG" type="color" value="#ffffff" />
          </div>
        </div>
        <div class="color-row" style="margin-top: 12px; grid-template-columns: 1fr; gap: 10px; align-items: stretch;">
          <div>
            <label id="logoBgLabel">á–ááŸŒáá¶á„á€áŸ’ášáŸ„á™ášá¼á”áŸá‰áŸ’á‰á¶</label>
            <input id="logoBg" type="color" value="#ffffff" />
          </div>
        </div>
        <div>
          <label id="captionLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1; display: block; margin-bottom: 4px;">á¢ááŸ’áá”á‘á›á¾á€á¼áŠ</label>
          <input id="overlayText" type="text" placeholder="á§. ááŸ‚á˜â€‹ á˜á¸" />
        </div>
        <div>
          <label id="logoLabel" style="font-size: 12px; font-weight: 600; color: #cbd5e1; display: block; margin-bottom: 4px;">á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–</label>
          <button id="logoUploadBtn" class="secondary" style="margin-top: 0;" onclick="document.getElementById('logoUpload').click();">ğŸ“ á‡áŸ’ášá¾áŸášá¼á”á—á¶á–</button>
          <input id="logoUpload" type="file" accept="image/*" style="display: none;" onchange="handleLogoUpload(this);" />
          <div id="logoPreview" class="logo-preview" style="display: none;"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; align-items: stretch;">
          <button class="primary" id="btnGenerate" style="min-height: 38px; height: 100%;">âœ¨ á”á„áŸ’á€á¾áá€á¼áŠ QR</button>
          <button class="ghost" id="btnClear" style="min-height: 38px; height: 100%;">ğŸ—‘ï¸ áŸá˜áŸ’á¢á¶á</button>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="section">
        <div id="previewLabel" style="font-size: 14px; font-weight: 700; color: #cbd5e1; margin-bottom: 12px;">á˜á¾á›á˜á»á“</div>
        <div id="qrPreview"><p id="previewHint">á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘ á á¾á™á…á»á…á”á„áŸ’á€á¾á</p></div>
      </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;">
      <button class="secondary" id="btnDownload" style="width: 100%;" disabled onclick="var dm = document.getElementById('downloadMenu'); var sm = document.getElementById('shareMenu'); sm.style.display = 'none'; dm.style.display = dm.style.display === 'block' ? 'none' : 'block';">ğŸ“¥ á‘á¶á‰á™á€</button>
      <button class="secondary" id="btnShare" style="width: 100%;" disabled onclick="var sm = document.getElementById('shareMenu'); var dm = document.getElementById('downloadMenu'); dm.style.display = 'none'; sm.style.display = sm.style.display === 'block' ? 'none' : 'block';">ğŸ“¤ á…áŸ‚á€ášáŸ†á›áŸ‚á€</button>
    </div>

  <!-- Download Format Selector -->
  <div id="downloadMenu" style="display: none; background: #0f172a; padding: 12px; border-radius: 6px; margin: 20px auto; max-width: 1400px; border: 1px solid #334155; margin-left: 8px; margin-right: 8px;">
    <p id="downloadFormatLabel" style="font-size: 12px; color: #cbd5e1; margin-bottom: 8px; font-weight: 600;">á‘á˜áŸ’ášá„áŸ‹á‘á¶á‰á™á€:</p>
    <div class="button-group">
      <button class="ghost" id="downloadPNG">ğŸ“„ PNG</button>
      <button class="ghost" id="downloadJPG">ğŸ“„ JPG</button>
      <button class="ghost" id="downloadPDF">ğŸ“„ PDF</button>
    </div>
  </div>

  <!-- Share Menu -->
  <div id="shareMenu" style="display: none; background: #0f172a; padding: 12px; border-radius: 6px; margin: 0 auto 20px; max-width: 1400px; border: 1px solid #334155; margin-left: 8px; margin-right: 8px;">
    <p id="shareToLabel" style="font-size: 12px; color: #cbd5e1; margin-bottom: 8px; font-weight: 600;">á…áŸ‚á€ášáŸ†á›áŸ‚á€á‘áŸ…:</p>
    <div class="button-group full">
      <button class="ghost" id="shareWhatsApp" onclick="shareToSocial('whatsapp');">ğŸ“± WhatsApp</button>
      <button class="ghost" id="shareFacebook" onclick="shareToSocial('facebook');">ğŸ‘ Facebook</button>
      <button class="ghost" id="shareTwitter" onclick="shareToSocial('twitter');">ğ• Twitter</button>
      <button class="ghost" id="shareTelegram" onclick="shareToSocial('telegram');">ğŸ’¬ Telegram</button>
    </div>
    <div class="button-group full" style="margin-top: 8px;">
      <button class="ghost" id="shareCopy" onclick="shareToSocial('copy');">ğŸ“‹ Copy Link</button>
      <button class="ghost" id="shareEmail" onclick="shareToSocial('email');">ğŸ“§ Email</button>
    </div>
  </div>
 </div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal">
    <div class="modal-content" style="max-width: 420px;">
      <button class="close-btn" style="position: absolute; top: 18px; right: 18px; font-size: 36px; color: #94a3b8; background: none; border: none; cursor: pointer;" onclick="document.getElementById('helpModal').classList.remove('active'); document.getElementById('helpModal').style.display = 'none';">&times;</button>
      <h2 id="helpTitle" style="color: #22d3a9; font-size: 32px; font-weight: 700; margin: 0 0 18px 0; text-align: center;">á‡áŸ†á“á½á™ - KMQR Generator Pro</h2>
      <div id="helpContent" style="font-size:16px;line-height:1.7;color:#e2e8f0;">
        <p><strong>ğŸ“– ášá”áŸ€á”á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹áŸ–</strong></p><p>1. á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘ á¬ URL á“áŸ…á€áŸ’á“á»á„á…áŸ€á“á›á·áá·á<br>2. á€áŸ‚áŸá˜áŸ’ášá½á›á‘áŸ†á áŸ† á–ááŸŒ á€áŸ†ášá·áá€áŸ‚á€áŸ†á á»áŸ<br>3. á”á“áŸ’ááŸ‚á˜ášá¼á”áŸá‰áŸ’á‰á¶ á á¾á™á¢ááŸ’áá”á‘á›á¾á€á¼áŠ (á‘áŸˆá…áŸááŸ’á)<br>4. á…á»á… "á”á„áŸ’á€á¾á QR" áŠá¾á˜áŸ’á”á¸á˜á¾á›á€á¼áŠášá”áŸáŸ‹á¢áŸ’á“á€<br>5. á‘á¶á‰á™á€á‡á¶ PNG, JPG, á¬ PDF</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>âœ¨ á˜á»áá„á¶ášáŸ–</strong><br>â€¢ á”á„áŸ’á€á¾áá€á¼áŠ QR á€áŸ’ášáŸ…á”áŸ’ášá–áŸá“áŸ’á’áŠáŸ„á™á‚áŸ’á˜á¶á“á¢áŸŠá¸á“á‘áºááŸá<br>â€¢ á”á“áŸ’ááŸ‚á˜ášá¼á”áŸá‰áŸ’á‰á¶ á á¾á™á¢ááŸ’áá”á‘á›á¾á€á¼áŠ<br>â€¢ á‘á¶á‰á™á€á‚á»áá—á¶á–ááŸ’á–áŸáŸ‹ (1x, 2x, 3x)<br>â€¢ á‚á¶áŸ†á‘áŸ’ášá—á¶áŸá¶á¢á„áŸ’á‚áŸ’á›áŸáŸ á á¾á™ááŸ’á˜áŸ‚áš<br>â€¢ á˜áŸ‰á¼áŠáŸá¶á€á›áŸ’á”á„ & áŠáŸ„á áŸáŸ„á›á‘áŸ†áá¶á˜á‘áŸ…<br>â€¢ á…áŸ‚á€ášáŸ†á›áŸ‚á€á›á¾á”áŸ’ášá–áŸá“áŸ’á’áŸá„áŸ’á€á˜</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>ğŸ”“ áŸáŸ’áœáŸ‚á„ášá€á›á¸áŸá¶á„áŸáŸ‹áŸ–</strong><br>ğŸ“§ <a href="mailto:my.khem.mathst@gmail.com" style="color: #3b82f6;">my.khem.mathst@gmail.com</a><br>ğŸ“± <a href="tel:+85566999313199" style="color: #3b82f6;">+855 66/99 931319</a><br>ğŸ’¬ <a href="https://t.me/khemmy99" target="_blank" style="color: #3b82f6;">Telegram: @khemmy99</a></p>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal">
    <div class="modal-content" style="max-width: 420px;">
      <button class="close-btn" onclick="document.getElementById('aboutModal').classList.remove('active'); document.getElementById('aboutModal').style.display = 'none';">&times;</button>
      <h2 id="aboutTitle" style="color: #3b82f6; font-size: 28px; font-weight: 700; margin: 0 0 12px 0; text-align: center;">á¢áŸ†á–á¸ KMQR Generator Pro</h2>
      <div id="aboutContent" style="font-size:16px;line-height:1.7;color:#e2e8f0;"></div>
    </div>
  </div>
  
  <!-- Footer Contact Info -->
  <div style="padding:20px;color:#cbd5e1;text-align:center;font-size:14px;background:#0f172a;border-top:1px solid #1e293b;">
    <div style="line-height:1.6;">
      <span id="footerPhone">á‘á¼ášáŸáŸá–áŸ’á‘: <a href="tel:+8556699313199" style="color:#3b82f6;">+855 66/99 931319</a></span> | 
      <span id="footerTelegram">ááŸá›áŸá€áŸ’ášá¶á˜: <a href="https://t.me/khemmy99" target="_blank" style="color:#3b82f6;">@khemmy99</a></span> | 
      <span id="footerFacebook">á áŸ’áœáŸá€á”á»á€: <a href="https://facebook.com/KMLOL" target="_blank" style="color:#3b82f6;">facebook.com/KMLOL</a></span> | 
      <span id="footerCopyright"><b id="footerCopyrightLabel">ášá€áŸ’áŸá¶áŸá·á‘áŸ’á’á·:</b> Â© 2026 ááŸ‚á˜ á˜á¸. <span id="footerRights">ášá€áŸ’áŸá¶áŸá·á‘áŸ’á’á·á‚áŸ’ášá”áŸ‹á™áŸ‰á¶á„áŸ”</span></span>
    </div>
  </div>
      </div>
    </div>
  </div>

  <!-- License Activation Modal -->
  <div id="activationModal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
      <h2 style="color: #10b981; text-align: center; margin-bottom: 20px;">ğŸ‰ Unlock Full Features</h2>
      
      <div style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #10b981;">
        <p style="font-size: 13px; color: #cbd5e1; margin-bottom: 12px; text-align: center;">
          <strong>Trial Mode:</strong> Generate QR codes freely
        </p>
        
        <p style="font-size: 13px; color: #cbd5e1; margin-bottom: 12px; text-align: center; line-height: 1.6;">
          <strong style="color: #10b981;">âœ… Currently Available:</strong><br>
          Generate QR codes with all customization options
        </p>

        <p id="downloadLockedMsg" style="font-size: 13px; color: #fbbf24; margin-bottom: 12px; text-align: center; line-height: 1.6; background: #1e293b; padding: 10px; border-radius: 6px; border: 1px solid #fbbf24;"></p>

        <div style="background: #0f172a; padding: 12px; border-radius: 6px; border: 1px solid #475569; margin-bottom: 12px;">
          <p id="fullVersionTitle" style="font-size: 12px; color: #cbd5e1; line-height: 1.6; margin-bottom: 8px;"></p>
          <p id="featuresList" style="font-size: 12px; color: #cbd5e1; line-height: 1.8;"></p>
        </div>
      </div>

      <button id="acceptLicense" class="primary" style="width: 100%; margin-top: 8px; background: linear-gradient(135deg, #10b981, #059669); border: none; cursor: pointer;"></button>
    </div>
  </div>

  <script>
    // ========== LICENSE ACTIVATION SYSTEM ==========
    function generateLicenseKey() {
      // Professional license code for demonstration
      return 'KMQR-PRO-2026';
    }

    function initializeLicense() {
      // App starts in TRIAL MODE by default unless user activated
      const isActivated = localStorage.getItem('kmqr_app_activated') === 'true';
      
      // Hide activation modal unless user chooses to activate from welcome
      document.getElementById('activationModal').classList.remove('active');
    }

    function copyTrialID() {
      // Not used in new trial mode
      return;
    }

    // Global handler functions for welcome buttons
    // (These are now handled via inline onclick for better compatibility)
    
    // Global variables
    let exportCanvas = null;
    let logoImage = null;
    
    // Handle logo upload
    function handleLogoUpload(input) {
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const reader = new FileReader();
        
        reader.onload = (event) => {
          logoImage = new Image();
          logoImage.onload = () => {
            document.getElementById('logoPreview').innerHTML = '<p>âœ“ ' + file.name + '</p>';
            document.getElementById('logoPreview').style.display = 'block';
          };
          logoImage.onerror = () => {
            alert('Failed to load logo image. Try a different file.');
            logoImage = null;
            document.getElementById('logoPreview').style.display = 'none';
            input.value = '';
          };
          logoImage.src = event.target.result;
        };
        reader.onerror = () => {
          alert('Failed to read file');
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Wrapper function for Generate button (kept for compatibility)
    window.generateQRCode = function() {
      const elText = document.getElementById('qrText');
      const elSize = document.getElementById('qrSize');
      const elEC = document.getElementById('qrEC');
      const elFG = document.getElementById('qrFG');
      const elBG = document.getElementById('qrBG');
      const qrPreview = document.getElementById('qrPreview');
      
      if (!elText || !elText.value) {
        alert(translations[currentLang].alertEnterText);
        return;
      }

      try {
        qrPreview.innerHTML = '';
        const size = parseInt(elSize.value);

        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        tempDiv.id = 'qr-temp-' + Date.now();
        document.body.appendChild(tempDiv);

        const qrInstance = new QRCode(tempDiv, {
          text: elText.value,
          width: size,
          height: size,
          colorDark: elFG.value,
          colorLight: elBG.value,
          correctLevel: QRCode.CorrectLevel[elEC.value]
        });

        setTimeout(() => {
          try {
            const canvas = tempDiv.querySelector('canvas');
            if (canvas) {
              exportCanvas = canvas;
              const imgData = canvas.toDataURL('image/png');
              const img = document.createElement('img');
              img.src = imgData;
              img.style.maxWidth = '100%';
              img.style.borderRadius = '6px';
              qrPreview.innerHTML = '';
              qrPreview.appendChild(img);
              document.getElementById('btnDownload').disabled = false;
              document.getElementById('btnShare').disabled = false;
            }
            if (document.body.contains(tempDiv)) {
              document.body.removeChild(tempDiv);
            }
          } catch (error) {
            console.error('Error processing canvas:', error);
            qrPreview.innerHTML = '<p style="color: #ef4444;">Error generating QR code</p>';
            if (document.body.contains(tempDiv)) {
              document.body.removeChild(tempDiv);
            }
          }
        }, 100);
      } catch (error) {
        console.error('Generate error:', error);
        alert('Error: ' + error.message);
      }
    };
    
    // Initialize welcome screen immediately when script loads
    function initializeWelcome() {
      console.log('initializeWelcome() called');
      
      // Check if user has ALREADY SEEN WELCOME (strict check)
      const hasSeenWelcome = localStorage.getItem('kmqr_welcome_shown') === 'true';
      
      const welcomeModal = document.getElementById('welcomeModal');
      
      console.log('hasSeenWelcome (strict):', hasSeenWelcome);
      
      if (welcomeModal) {
        // If already seen welcome, skip modal and show app
        if (hasSeenWelcome) {
          console.log('Welcome skipped - showing app (user has seen before)');
          welcomeModal.style.display = 'none';
          // Show all app containers and header
          document.querySelectorAll('.container').forEach(el => el.style.display = 'block');
          document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'block');
          document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'block');
          // Update button visibility based on activation
          updateActivationStatus();
        } else {
          // First time user - show welcome
          console.log('Welcome shown - first time user (no kmqr_welcome_shown in storage)');
          welcomeModal.style.display = 'block';
          // Hide app containers during welcome
          document.querySelectorAll('.container').forEach(el => el.style.display = 'none');
          document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'none');
          document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'none');
        }
      }
      
      // Hide loading screen after 500ms
      setTimeout(() => {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
          loadingScreen.classList.add('hidden');
          loadingScreen.style.display = 'none';
        }
      }, 500);
      
      // Check for updates
      checkForUpdates();
    }

    // ========== UPDATE CHECK SYSTEM ==========
    const LATEST_VERSION = '1.0.8'; // Update this when releasing new version
    
    function checkForUpdates() {
      const currentVersion = localStorage.getItem('kmqr_version_loaded') || KMQR_VERSION;
      
      // Store last checked time
      const lastChecked = localStorage.getItem('kmqr_last_update_check');
      const now = Date.now();
      
      // Check every 6 hours or on first load
      if (!lastChecked || (now - parseInt(lastChecked)) > 6 * 60 * 60 * 1000) {
        localStorage.setItem('kmqr_last_update_check', now.toString());
        
        // Compare versions
        if (LATEST_VERSION !== currentVersion) {
          showUpdateBanner();
        }
      }
    }
    
    function showUpdateBanner() {
      const banner = document.getElementById('updateBanner');
      const updateBtn = document.getElementById('updateCheckBtn');
      if (banner) banner.style.display = 'block';
      if (updateBtn) updateBtn.style.display = 'block';
    }
    
    function performUpdate() {
      // Clear cache and reload
      // Show update info modal with only version and contact message
      document.getElementById('helpModal').classList.remove('active');
      document.getElementById('helpModal').style.display = 'none';
      document.getElementById('licenseModal').classList.remove('active');
      document.getElementById('licenseModal').style.display = 'none';
      document.getElementById('aboutModal').classList.remove('active');
      document.getElementById('aboutModal').style.display = 'none';
      var updateInfoModal = document.getElementById('updateInfoModal');
      var updateInfoContent = document.getElementById('updateInfoContent');
      var msg = '';
      var heading = '';
      if (currentLang === 'km') {
        heading = 'á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–á€á˜áŸ’á˜áœá·á’á¸';
        msg = '<div style="font-size:18px;font-weight:700;color:#f59e0b;">á‡áŸ†á“á¶á“áŸ‹ áŸ¡.áŸ .áŸ¨</div>' +
          '<div style="margin-bottom:8px;">áŸá˜áŸ’ášá¶á”áŸ‹á’áŸ’áœá¾á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á– áŸá¼á˜á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá“áŸ</div>' +
          '<div style="color:#3b82f6;">'
          + '<span style="display:block;margin-bottom:4px;">á¢áŸŠá¸á˜áŸ‚á›: <a href="mailto:my.khem.mathst@gmail.com" style="color:#3b82f6;text-decoration:underline;">my.khem.mathst@gmail.com</a></span>'
          + '<span style="display:block;margin-bottom:4px;">á‘á¼ášáŸáŸá–áŸ’á‘: <a href="tel:+8556699313199" style="color:#3b82f6;text-decoration:underline;">+855 66/99 931319</a></span>'
          + '<span style="display:block;">ááŸá›áŸá€áŸ’ášá¶á˜: <a href="https://t.me/khemmy99" target="_blank" style="color:#3b82f6;text-decoration:underline;">@khemmy99</a></span>'
          + '</div>';
        // Update modal heading only
        document.querySelector('#updateInfoModal h2').textContent = heading;
      } else {
        heading = 'Update Info';
        msg = '<div style="font-size:18px;font-weight:700;color:#f59e0b;">Version 1.0.8</div>' +
          '<div style="margin:16px 0 8px 0;">For update, please contact developer</div>' +
          '<div style="color:#3b82f6;">'
          + '<span style="display:block;margin-bottom:4px;">E-mail: <a href="mailto:my.khem.mathst@gmail.com" style="color:#3b82f6;text-decoration:underline;">my.khem.mathst@gmail.com</a></span>'
          + '<span style="display:block;margin-bottom:4px;">Phone: <a href="tel:+8556699313199" style="color:#3b82f6;text-decoration:underline;">+855 66/99 931319</a></span>'
          + '<span style="display:block;">Telegram: <a href="https://t.me/khemmy99" target="_blank" style="color:#3b82f6;text-decoration:underline;">@khemmy99</a></span>'
          + '</div>';
        document.querySelector('#updateInfoModal h2').textContent = heading;
      }
      updateInfoContent.innerHTML = msg;
      updateInfoModal.classList.add('active');
      updateInfoModal.style.display = 'flex';
      // If you want to allow update after info, uncomment below:
      // if (confirm('Continue to update?')) {
      //   localStorage.setItem('kmqr_version_loaded', LATEST_VERSION);
      //   if (localStorage.getItem('kmqr_app_activated') === 'true') {
      //     localStorage.setItem('kmqr_welcome_shown', 'true');
      //   }
      //   window.location.href = window.location.href.split('?')[0] + '?v=' + LATEST_VERSION + '&t=' + Date.now();
      // }
    }

    // Run initialization immediately
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeWelcome);
    } else {
      initializeWelcome();
    }

    // Also accept license button handler
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded fired - all buttons should be ready');
        // Set all button text to default language on first load
        updateLanguage(currentLang);
        updateActivationStatus();
      
      // Attach update button handler
      const updateNowBtn = document.getElementById('updateNowBtn');
      const updateCheckBtn = document.getElementById('updateCheckBtn');
      if (updateNowBtn) {
        updateNowBtn.onclick = performUpdate;
      }
      if (updateCheckBtn) {
        updateCheckBtn.onclick = performUpdate;
      }
    });
    
    
    function updateActivationStatus() {
      const isActivated = localStorage.getItem('kmqr_app_activated') === 'true';
      const statusDiv = document.getElementById('activationStatus');
      const activateBtn = document.getElementById('activateBtn');
      
      if (isActivated) {
        if (statusDiv) statusDiv.style.display = 'block';
        // Show deactivate button (red/orange style)
        if (activateBtn) {
          activateBtn.textContent = translations[currentLang].btnDeactivate;
          activateBtn.style.display = 'block';
          activateBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
          activateBtn.style.backgroundImage = 'linear-gradient(135deg, #ef4444, #dc2626)';
          activateBtn.style.cursor = 'pointer';
          activateBtn.style.opacity = '1';
          activateBtn.style.boxShadow = '0 2px 6px rgba(239,68,68,0.25)';
          activateBtn.onclick = function() {
            // Confirm deactivation
            if (confirm(translations[currentLang].confirmDeactivate)) {
              // Clear license and activation
              localStorage.removeItem('kmqr_app_activated');
              localStorage.removeItem('kmqr_license_code');
              localStorage.removeItem('kmqr_welcome_shown');
              
              // Close any open modals
              document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
                modal.style.display = 'none';
              });
              
              // Show license modal directly after deactivation
              const licenseModal = document.getElementById('licenseModal');
              if (licenseModal) {
                licenseModal.classList.add('active');
                licenseModal.style.display = 'flex';
              }
              // Hide app
              document.querySelectorAll('.container').forEach(el => el.style.display = 'none');
              document.querySelectorAll('.main-wrapper').forEach(el => el.style.display = 'none');
              document.querySelectorAll('[style*="position: sticky"]').forEach(el => el.style.display = 'none');
              // Update button
              updateActivationStatus();
            }
          };
        }
      } else {
        if (statusDiv) statusDiv.style.display = 'none';
        // Show activate button (green style)
        if (activateBtn) {
          activateBtn.textContent = translations[currentLang].btnActivate;
          activateBtn.style.display = 'block';
          activateBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
          activateBtn.style.backgroundImage = 'linear-gradient(135deg, #10b981, #059669)';
          activateBtn.style.cursor = 'pointer';
          activateBtn.style.opacity = '1';
          activateBtn.style.boxShadow = '0 2px 6px rgba(16,185,129,0.25)';
          activateBtn.onclick = function() {
            document.getElementById('licenseModal').classList.add('active');
            document.getElementById('licenseModal').style.display = 'flex';
          };
        }
      }
    }

    // ========== QR CODE GENERATOR ==========
    // Translations
    const translations = {
      en: {
        title: 'KMQR Generator',
        aboutContent: '',
        textLabel: 'Text or URL',
        textPlaceholder: 'Enter text, URL, or Khmer...',
        sizeLabel: 'Size',
        ecLabel: 'Error Correction',
        ecLow: 'Low',
        ecMedium: 'Medium',
        ecQuartile: 'Quartile',
        ecHigh: 'High',
        dpiLabel: 'Quality (DPI)',
        roundLabel: 'Round Logo',
        yes: 'Yes',
        no: 'No',
        fgLabel: 'Foreground',
        bgLabel: 'Background',
        logoBgLabel: 'Logo BG',
        captionLabel: 'Overlay Text',
        captionPlaceholder: 'e.g. KHEM MY',
        logoLabel: 'Choose Logo',
        logoUploadBtn: 'ğŸ“ Select Image',
        previewLabel: 'Preview',
        btnGenerate: 'Generate QR',
        btnDownload: 'ğŸ“¥ Download',
        btnClear: 'Clear',
        btnHelp: 'Help',
        btnAbout: 'About',
        btnShare: 'ğŸ“¤ Share',
        updateBtn: 'ğŸ”„ Update',
        previewHint: 'Enter text and click Generate',
        alertEnterText: 'Please enter text or URL',
        downloadFormatLabel: 'Download Format:',
        shareToLabel: 'Share to:',
        alertDownloadLocked: 'ğŸ”’ Download is locked in Trial Mode\n\nClick the GREEN ACTIVATE button to unlock all downloads!',
        footerPhone: 'Phone:',
        footerTelegram: 'Telegram:',
        footerFacebook: 'Facebook:',
        footerCopyright: 'Copyright:',
        footerRights: 'All rights reserved.',
        // License & Activation
        welcomeTitle: 'ğŸ‰ Welcome to KMQR',
        welcomeSubtitle: 'Generate QR codes with professional features',
        btnEnterLicense: 'âœ… Enter License',
        btnSkipTrial: 'â­ï¸ Try Free',
        trialModeInfo: 'Trial mode: Generate & customize QR codes freely<br>Full license: Unlock all download formats',
        licenseModalTitle: 'ğŸ”“ Enter License Code',
        licenseInstructions: '<strong>Paste your license code below to unlock full features:</strong>',
        licensePlaceholder: 'Enter your license code here...',
        licenseContactInfo: 'ğŸ“§ Don\'t have a license code?<br>Contact: <strong>my.khem.mathst@gmail.com</strong><br>ğŸ“± Phone: <strong>+855 66/99 931319</strong><br>ğŸ’¬ Telegram: <strong>@khemmy99</strong>',
        btnActivateLicense: 'âœ… Activate',
        btnCancelLicense: 'Cancel',
        btnActivate: 'ğŸ”“ Activate',
        btnDeactivate: 'ğŸ”’ Deactivate',
        confirmDeactivate: 'Are you sure you want to deactivate? You will need to enter a license code again.',
        downloadLocked: '<strong>ğŸ”’ Download is Locked</strong><br>Click ACTIVATE to unlock all download formats',
        fullVersionFeatures: '<strong>âœ¨ Full Version Unlocks:</strong>',
        featuresList: 'âœ“ Download PNG format<br>âœ“ Download JPG format<br>âœ“ Download PDF format<br>âœ“ Unlimited QR codes<br>âœ“ All customization options',
        btnActivateNow: 'ğŸ‰ Activate Now',
        alertEnterLicense: 'âŒ Please enter a license code',
        alertInvalidLicense: 'âŒ Invalid license code format.\\n\\nValid codes start with KMQR- or TRIAL-\\n\\nExample: KMQR-ABC123',
        helpTitle: 'Help',
        helpContent: '<p><strong>ğŸ“– How to Use:</strong></p><p>1. Enter text or URL in the input field<br>2. Customize size, colors, error correction<br>3. Add logo (optional)<br>4. Click "Generate QR" to create the code<br>5. Download as PNG, JPG, or PDF</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>âœ¨ Features:</strong><br>â€¢ Offline QR code generation<br>â€¢ Logo overlay with customizable background<br>â€¢ High-quality DPI export (1x, 2x, 3x)<br>â€¢ English & Khmer bilingual support<br>â€¢ Trial Mode & License Activation<br>â€¢ Social media sharing</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>ğŸ”“ Get License:</strong><br>ğŸ“§ <a href="mailto:my.khem.mathst@gmail.com" style="color: #3b82f6;">my.khem.mathst@gmail.com</a><br>ğŸ“± <a href="tel:+85566999313199" style="color: #3b82f6;">+855 66/99 931319</a><br>ğŸ’¬ <a href="https://t.me/khemmy99" target="_blank" style="color: #3b82f6;">Telegram: @khemmy99</a></p>',
        aboutTitle: 'About',
        version: 'Version 1.0.8',
        developerLabel: 'ğŸ‘¨â€ğŸ’» Developer:',
        developer: 'Khem My<br><em>Full-Stack Web Developer</em><br><em>QR Code Specialist</em>',
        deviceIdLabel: 'Device ID (for license):',
      },
      km: {
        title: 'á€á˜áŸ’á˜áœá·á’á¸á”á„áŸ’á€á¾á QR',
        aboutContent: '',
        textLabel: 'á¢ááŸ’áá”á‘ á¬ URL',
        textPlaceholder: 'á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘, URL, á¬á—á¶áŸá¶ááŸ’á˜áŸ‚ášâ€¦',
        sizeLabel: 'á‘áŸ†á áŸ†',
        ecLabel: 'á€á˜áŸ’ášá·áá€áŸ‚á€áŸ†á á»áŸ',
        ecLow: 'á‘á¶á”',
        ecMedium: 'á˜á’áŸ’á™á˜',
        ecQuartile: 'ááŸ’á–áŸáŸ‹',
        ecHigh: 'ááŸ’á–áŸáŸ‹á”áŸ†á•á»á',
        dpiLabel: 'á‚á»áá—á¶á– (DPI)',
        roundLabel: 'ášá¼á”áŸá‰áŸ’á‰á¶á˜á¼á›',
        yes: 'á”á¶á‘/á…á¶áŸ',
        no: 'á‘áŸ',
        fgLabel: 'á–ááŸŒá˜á»á',
        bgLabel: 'á–ááŸŒáá¶á„á€áŸ’ášáŸ„á™',
        logoBgLabel: 'á–ááŸŒáá¶á„á€áŸ’ášáŸ„á™ášá¼á”áŸá‰áŸ’á‰á¶',
        captionLabel: 'á¢ááŸ’áá”á‘á›á¾á€á¼áŠ',
        captionPlaceholder: 'á§. ááŸ‚á˜â€‹ á˜á¸',
        logoLabel: 'á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–',
        logoUploadBtn: 'ğŸ“ á‡áŸ’ášá¾áŸášá¼á”á—á¶á–',
        previewLabel: 'á˜á¾á›á˜á»á“',
        btnGenerate: 'âœ¨ á”á„áŸ’á€á¾áá€á¼áŠ QR',
        btnDownload: 'ğŸ“¥ á‘á¶á‰á™á€',
        btnClear: 'áŸá˜áŸ’á¢á¶á',
        btnHelp: 'á‡áŸ†á“á½á™',
        btnAbout: 'á¢áŸ†á–á¸á€á˜áŸ’á˜áœá·á’á¸',
        btnShare: 'ğŸ“¤ á…áŸ‚á€ášáŸ†á›áŸ‚á€',
        updateBtn: 'ğŸ”„ á€áŸ†ááŸ‚á€á˜áŸ’á˜áœá·á’á¸',
        previewHint: 'á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘ á á¾á™á…á»á…á”á„áŸ’á€á¾á',
        alertEnterText: 'áŸá¼á˜á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘ á¬ URL',
        downloadFormatLabel: 'á‘á˜áŸ’ášá„áŸ‹á‘á¶á‰á™á€áŸ–',
        shareToLabel: 'á…áŸ‚á€ášáŸ†á›áŸ‚á€á‘áŸ…áŸ–',
        alertDownloadLocked: 'ğŸ”’ á€á¶ášá‘á¶á‰á™á€ááŸ’ášá¼áœá”á¶á“á…á¶á€áŸ‹áŸáŸ„\n\ná…á»á…á”á¼áá»á„á–ááŸŒá”áŸƒáá„áŠá¾á˜áŸ’á”á¸áŠáŸ„áŸ‡áŸáŸ„ášá‘á¶á‰á™á€á‘á¶áŸ†á„á¢áŸáŸ‹!',
        footerPhone: 'á‘á¼ášáŸáŸá–áŸ’á‘:',
        footerTelegram: 'ááŸá›áŸá€áŸ’ášá¶á˜:',
        footerFacebook: 'á áŸ’áœáŸá€á”á»á€:',
        footerCopyright: 'ášá€áŸ’áŸá¶áŸá·á‘áŸ’á’á·:',
        footerRights: 'ášá€áŸ’áŸá¶áŸá·á‘áŸ’á’á·á‚áŸ’ášá”áŸ‹á™áŸ‰á¶á„áŸ”',
        // License & Activation
        welcomeTitle: 'ğŸ‰ áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸá˜á€á€á¶á“áŸ‹ KMQR',
        welcomeSubtitle: 'á”á„áŸ’á€á¾áá€á¼áŠ QR á‡á¶á˜á½á™á˜á»áá„á¶ášáœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ',
        btnEnterLicense: 'âœ… á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠ',
        btnSkipTrial: 'â­ï¸ áŸá¶á€á›áŸ’á”á„á¥áá‚á·áááŸ’á›áŸƒ',
        trialModeInfo: 'á˜áŸ‰á¼áŠáŸá¶á€á›áŸ’á”á„áŸ– á”á„áŸ’á€á¾á á“á·á„á€áŸ‚áŸá˜áŸ’ášá½á› QR áŠáŸ„á™áŸáŸášá¸<br>á›á¸áŸá·á“áŸ’áŸá–áŸá‰á›áŸá‰áŸ– áŠáŸ„áŸ‡áŸáŸ„á‘á¶á‰á™á€á‚áŸ’ášá”áŸ‹á‘á˜áŸ’ášá„áŸ‹',
        licenseModalTitle: 'ğŸ”“ á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠ',
        licenseInstructions: '<strong>á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠášá”áŸáŸ‹á¢áŸ’á“á€áá¶á„á€áŸ’ášáŸ„á˜áŠá¾á˜áŸ’á”á¸áŠáŸ„áŸ‡áŸáŸ„á˜á»áá„á¶ášá–áŸá‰á›áŸá‰áŸ–</strong>',
        licensePlaceholder: 'á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠášá”áŸáŸ‹á¢áŸ’á“á€á“áŸ…á‘á¸á“áŸáŸ‡...',
        licenseContactInfo: 'ğŸ“§ á˜á·á“á˜á¶á“á›áŸáá€á¼áŠá‘áŸ?<br>á‘áŸ†á“á¶á€áŸ‹á‘áŸ†á“á„áŸ– <strong>my.khem.mathst@gmail.com</strong><br>ğŸ“± á‘á¼ášáŸáŸá–áŸ’á‘áŸ– <strong>+855 66/99 931319</strong><br>ğŸ’¬ TelegramáŸ– <strong>@khemmy99</strong>',
        btnActivateLicense: 'âœ… á’áŸ’áœá¾á±áŸ’á™áŸá€á˜áŸ’á˜',
        btnCancelLicense: 'á”áŸ„áŸ‡á”á„áŸ‹',
        btnActivate: 'ğŸ”“ á’áŸ’áœá¾á±áŸ’á™áŸá€á˜áŸ’á˜',
        btnDeactivate: 'ğŸ”’ á”á·á‘áŸá€á˜áŸ’á˜',
        confirmDeactivate: 'áá¾á¢áŸ’á“á€á–á·áá‡á¶á”áŸ’ášá¶á€áŠá…á„áŸ‹á”á·á‘áŸá€á˜áŸ’á˜á‘áŸ? á¢áŸ’á“á€á“á¹á„ááŸ’ášá¼áœá”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠá˜áŸ’áá„á‘áŸ€ááŸ”',
        downloadLocked: '<strong>ğŸ”’ á€á¶ášá‘á¶á‰á™á€ááŸ’ášá¼áœá”á¶á“á…á¶á€áŸ‹áŸáŸ„</strong><br>á…á»á…á’áŸ’áœá¾á±áŸ’á™áŸá€á˜áŸ’á˜áŠá¾á˜áŸ’á”á¸áŠáŸ„áŸ‡áŸáŸ„á‘á˜áŸ’ášá„áŸ‹á‘á¶á‰á™á€á‘á¶áŸ†á„á¢áŸáŸ‹',
        fullVersionFeatures: '<strong>âœ¨ á€áŸ†ááŸ‚á–áŸá‰á›áŸá‰áŠáŸ„áŸ‡áŸáŸ„áŸ–</strong>',
        featuresList: 'âœ“ á‘á¶á‰á™á€á‘á˜áŸ’ášá„áŸ‹ PNG<br>âœ“ á‘á¶á‰á™á€á‘á˜áŸ’ášá„áŸ‹ JPG<br>âœ“ á‘á¶á‰á™á€á‘á˜áŸ’ášá„áŸ‹ PDF<br>âœ“ á€á¼áŠ QR á‚áŸ’á˜á¶á“áŠáŸ‚á“á€áŸ†áááŸ‹<br>âœ“ á‡á˜áŸ’ášá¾áŸá€áŸ‚áŸá˜áŸ’ášá½á›á‘á¶áŸ†á„á¢áŸáŸ‹',
        btnActivateNow: 'ğŸ‰ á’áŸ’áœá¾á±áŸ’á™áŸá€á˜áŸ’á˜á¥á¡á¼áœ',
        alertEnterLicense: 'âŒ áŸá¼á˜á”á‰áŸ’á…á¼á›á›áŸáá€á¼áŠ',
        alertInvalidLicense: 'âŒ á‘á˜áŸ’ášá„áŸ‹á›áŸáá€á¼áŠá˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”\\n\\ná›áŸáá€á¼áŠááŸ’ášá¹á˜ááŸ’ášá¼áœá…á¶á”áŸ‹á•áŸ’áá¾á˜áŠáŸ„á™ KMQR- á¬ TRIAL-\\n\\ná§á‘á¶á ášááŸáŸ– KMQR-ABC123',
        helpTitle: 'ááŸ‚á“á¶áŸ†á–á¸ášá”áŸ€á”á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹',
        helpContent: '<p><strong>ğŸ“– ášá”áŸ€á”á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹áŸ–</strong></p><p>áŸ¡. á”á‰áŸ’á…á¼á›á¢ááŸ’áá”á‘ á¬ URL á“áŸ…á€áŸ’á“á»á„áœá¶á›á”á‰áŸ’á…á¼á›<br>áŸ¢. á€áŸ‚á›á˜áŸ’á¢á‘áŸ†á áŸ† á–ááŸŒ á“á·á„á€á˜áŸ’ášá·áá€áŸ‚á€áŸ†á á»áŸ<br>áŸ£. á”á“áŸ’ááŸ‚á˜ášá¼á”áŸá‰áŸ’á‰á¶(á”á“áŸ’ááŸ‚á˜)<br>áŸ¤. á…á»á… "á”á„áŸ’á€á¾áá€á¼áŠ QR" áŠá¾á˜áŸ’á”á¸á”á„áŸ’á€á¾áá›áŸáá€á¼áŠ<br>áŸ¥. á‘á¶á‰á™á€á‡á¶ PNG, JPG á¬ PDF</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>âœ¨ á›á€áŸ’áááŸˆá–á·áŸáŸáŸáŸ–</strong><br>â€¢ á”á„áŸ’á€á¾áá›áŸáá€á¼áŠ QR áŠáŸ„á™áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·<br>â€¢ ášá¼á”áŸá‰áŸ’á‰á¶á›á¾áŸáŸ’ášá‘á¶á”áŸ‹áŠáŸ‚á›á”á¶á“á›á˜áŸ’á¢<br>â€¢ á“á¶áŸ†á…áŸá‰á‚á»áá—á¶á–ááŸ’á–áŸáŸ‹ DPI (1x, 2x, 3x)<br>â€¢ á”áŸ’ášá¾á”á¶á“á–á¸ášá—á¶áŸá¶áš(á¢á„áŸ‹á‚áŸ’á›áŸáŸ & ááŸ’á˜áŸ‚áš)<br>â€¢ á€á˜áŸ’á˜áœá·á’á¸áŸá¶á€á›áŸ’á”á„ á“á·á„á€á˜áŸ’á˜áœá·á’á¸á‘á·á‰á€á˜áŸ’á˜áŸá·á‘áŸ’á’á·<br>â€¢ á…áŸ‚á€ášáŸ†á›áŸ‚á€á›á¾á˜áŸáŒáŸ€</p><hr style="margin: 16px 0; border: none; border-top: 1px solid #475569;"><p><strong>ğŸ”“ á‘á‘á½á›áŸá·á‘áŸ’á’á·á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹áŸ–</strong><br>ğŸ“§ <a href="mailto:my.khem.mathst@gmail.com" style="color: #3b82f6;">my.khem.mathst@gmail.com</a><br>ğŸ“± <a href="tel:+85566999313199" style="color: #3b82f6;">+855 66/99 931319</a><br>ğŸ’¬ <a href="https://t.me/khemmy99" target="_blank" style="color: #3b82f6;">Telegram: @khemmy99</a></p>',
        aboutTitle: 'á¢áŸ†á–á¸á€á˜áŸ’á˜áœá·á’á¸',
        version: 'á‡áŸ†á“á¶á“áŸ‹ áŸ¡.áŸ .áŸ¨',
        developerLabel: 'ğŸ‘¨â€ğŸ’» á¢áŸ’á“á€á”á„áŸ’á€á¾ááŸ–',
        developer: 'ááŸ‚á˜ á˜á¸<br><em>á¢áŸ’á“á€á¢á—á·áœáŒáŸ’áá€á˜áŸ’á˜áœá·á’á¸</em><br><em>á¯á€á‘áŸáŸ QR Code</em>',
        deviceIdLabel: 'á›áŸááŸá˜áŸ’á‚á¶á›áŸ‹á§á”á€ášááŸ (áŸá˜áŸ’ášá¶á”áŸ‹á›á¸áŸá·á“áŸ’áŸ):',
      }
    };

    // Initialize button text based on current language
    const initLangBtn = document.getElementById('langToggle');
    if (initLangBtn) {
      initLangBtn.textContent = currentLang === 'en' ? 'ğŸŒ ááŸ’á˜áŸ‚áš' : 'ğŸŒ English';
    }

    function updateLanguage(lang) {
        // Update About button caption for language
        if (document.getElementById('btnAbout2Text')) document.getElementById('btnAbout2Text').textContent = t.btnAbout;
      currentLang = lang;
      localStorage.setItem('kmqr_lang', lang);
      const t = translations[lang];
      
      if (document.getElementById('title')) document.getElementById('title').textContent = t.title;
      if (document.getElementById('textLabel')) document.getElementById('textLabel').textContent = t.textLabel;
      if (document.getElementById('qrText')) document.getElementById('qrText').placeholder = t.textPlaceholder;
      if (document.getElementById('sizeLabel')) document.getElementById('sizeLabel').textContent = t.sizeLabel;
      if (document.getElementById('ecLabel')) document.getElementById('ecLabel').textContent = t.ecLabel;
      if (document.getElementById('ecLow')) document.getElementById('ecLow').textContent = t.ecLow;
      if (document.getElementById('ecMedium')) document.getElementById('ecMedium').textContent = t.ecMedium;
      if (document.getElementById('ecQuartile')) document.getElementById('ecQuartile').textContent = t.ecQuartile;
      if (document.getElementById('ecHigh')) document.getElementById('ecHigh').textContent = t.ecHigh;
      if (document.getElementById('dpiLabel')) document.getElementById('dpiLabel').textContent = t.dpiLabel;
      if (document.getElementById('roundLabel')) document.getElementById('roundLabel').textContent = t.roundLabel;
      if (document.getElementById('yes')) document.getElementById('yes').textContent = t.yes;
      if (document.getElementById('no')) document.getElementById('no').textContent = t.no;
      if (document.getElementById('fgLabel')) document.getElementById('fgLabel').textContent = t.fgLabel;
      if (document.getElementById('bgLabel')) document.getElementById('bgLabel').textContent = t.bgLabel;
      if (document.getElementById('logoBgLabel')) document.getElementById('logoBgLabel').textContent = t.logoBgLabel;
      if (document.getElementById('captionLabel')) document.getElementById('captionLabel').textContent = t.captionLabel;
      if (document.getElementById('overlayText')) document.getElementById('overlayText').placeholder = t.captionPlaceholder;
      if (document.getElementById('logoLabel')) document.getElementById('logoLabel').textContent = t.logoLabel;
      if (document.getElementById('logoUploadBtn')) document.getElementById('logoUploadBtn').textContent = t.logoUploadBtn;
      if (document.getElementById('previewLabel')) document.getElementById('previewLabel').textContent = t.previewLabel;
      if (document.getElementById('btnGenerate')) document.getElementById('btnGenerate').textContent = t.btnGenerate;
      if (document.getElementById('btnDownload')) document.getElementById('btnDownload').textContent = t.btnDownload;
      if (document.getElementById('btnClear')) document.getElementById('btnClear').textContent = t.btnClear;
      if (document.getElementById('btnHelp2')) document.getElementById('btnHelp2').textContent = t.btnHelp;
      if (document.getElementById('btnAbout2')) document.getElementById('btnAbout2').textContent = t.btnAbout;
      if (document.getElementById('btnShare')) document.getElementById('btnShare').textContent = t.btnShare;
      if (document.getElementById('updateCheckBtn')) {
        const btn = document.getElementById('updateCheckBtn');
        btn.textContent = t.updateBtn || 'ğŸ”„ Update';
        btn.style.display = 'inline-block';
        btn.onclick = performUpdate;
      }
      if (document.getElementById('updateNowBtn')) {
        const btn = document.getElementById('updateNowBtn');
        btn.textContent = t.updateBtn || 'ğŸ”„ Update';
        btn.style.display = 'inline-block';
        btn.onclick = performUpdate;
      }
      if (document.getElementById('previewHint')) document.getElementById('previewHint').textContent = t.previewHint;
      if (document.getElementById('previewHint')) document.getElementById('previewHint').textContent = t.previewHint;
      if (document.getElementById('downloadFormatLabel')) document.getElementById('downloadFormatLabel').textContent = t.downloadFormatLabel;
      if (document.getElementById('shareToLabel')) document.getElementById('shareToLabel').textContent = t.shareToLabel;
      if (document.getElementById('helpTitle')) document.getElementById('helpTitle').textContent = t.helpTitle;
      if (document.getElementById('helpContent')) document.getElementById('helpContent').innerHTML = t.helpContent;
      if (document.getElementById('aboutTitle')) document.getElementById('aboutTitle').textContent = t.aboutTitle;
      // Always show version and developer info in About modal
      if (document.getElementById('aboutContent')) {
        var aboutHtml = '<div style="text-align:center;"><b>' + t.title + '</b></div>';
        aboutHtml += '<div style="margin-top:8px;font-size:15px;"><b>' + t.version + '</b><br><span>' + t.developerLabel + '</span> <span>' + t.developer + '</span></div>';
        document.getElementById('aboutContent').innerHTML = aboutHtml;
      }
      
      // License & Activation elements
      if (document.getElementById('welcomeTitle')) document.getElementById('welcomeTitle').textContent = t.welcomeTitle;
      if (document.getElementById('welcomeSubtitle')) document.getElementById('welcomeSubtitle').textContent = t.welcomeSubtitle;
      if (document.getElementById('btnEnterLicense')) document.getElementById('btnEnterLicense').textContent = t.btnEnterLicense;
      if (document.getElementById('btnSkipTrial')) document.getElementById('btnSkipTrial').textContent = t.btnSkipTrial;
      if (document.getElementById('trialModeInfo')) document.getElementById('trialModeInfo').innerHTML = t.trialModeInfo;
      if (document.getElementById('licenseModalTitle')) document.getElementById('licenseModalTitle').textContent = t.licenseModalTitle;
      if (document.getElementById('licenseInstructions')) document.getElementById('licenseInstructions').innerHTML = t.licenseInstructions;
      if (document.getElementById('licenseCodeInput')) document.getElementById('licenseCodeInput').placeholder = t.licensePlaceholder;
      if (document.getElementById('licenseContactInfo')) document.getElementById('licenseContactInfo').innerHTML = t.licenseContactInfo;
      // Update device ID info in license modal
      if (document.getElementById('deviceIdInfo')) updateDeviceIdInfo();
      if (document.getElementById('btnActivateLicense')) document.getElementById('btnActivateLicense').textContent = t.btnActivateLicense;
      if (document.getElementById('btnCancelLicense')) document.getElementById('btnCancelLicense').textContent = t.btnCancelLicense;
      if (document.getElementById('downloadLockedMsg')) document.getElementById('downloadLockedMsg').innerHTML = t.downloadLocked;
      if (document.getElementById('fullVersionTitle')) document.getElementById('fullVersionTitle').innerHTML = t.fullVersionFeatures;
      if (document.getElementById('featuresList')) document.getElementById('featuresList').innerHTML = t.featuresList;
      if (document.getElementById('acceptLicense')) document.getElementById('acceptLicense').textContent = t.btnActivateNow;
      
      // Update footer (single line format with separators)
      const footerPhone = document.getElementById('footerPhone');
      const footerTelegram = document.getElementById('footerTelegram');
      const footerFacebook = document.getElementById('footerFacebook');
      const footerCopyrightLabel = document.getElementById('footerCopyrightLabel');
      const footerRights = document.getElementById('footerRights');
      
      if (footerPhone) footerPhone.innerHTML = t.footerPhone + ' <a href="tel:+8556699313199" style="color:#3b82f6;">+855 66/99 931319</a>';
      if (footerTelegram) footerTelegram.innerHTML = t.footerTelegram + ' <a href="https://t.me/khemmy99" target="_blank" style="color:#3b82f6;">@khemmy99</a>';
      if (footerFacebook) footerFacebook.innerHTML = t.footerFacebook + ' <a href="https://facebook.com/KMLOL" target="_blank" style="color:#3b82f6;">facebook.com/KMLOL</a>';
      if (footerCopyrightLabel) footerCopyrightLabel.textContent = t.footerCopyright;
      if (footerRights) {
        const nameText = (lang === 'km') ? 'ááŸ‚á˜ á˜á¸' : 'Khem My';
        footerRights.textContent = t.footerRights;
        // Update copyright section
        const footerCopyright = document.getElementById('footerCopyright');
        if (footerCopyright) {
          footerCopyright.innerHTML = '<b id="footerCopyrightLabel">' + t.footerCopyright + '</b> Â© 2026 ' + nameText + '. <span id="footerRights">' + t.footerRights + '</span>';
        }
      }
      
      // Update language button text
      const btnToggle = document.getElementById('langToggle');
      if (btnToggle) {
        btnToggle.textContent = lang === 'en' ? 'ğŸŒ ááŸ’á˜áŸ‚áš' : 'ğŸŒ English';
      }
      
      // Apply Khmer font styling to modals when Khmer is selected
      const helpContent = document.getElementById('helpContent');
      const aboutContent = document.getElementById('aboutContent');
      if (lang === 'km') {
        helpContent.style.fontFamily = "'Hanuman', 'Khmer OS', 'Siemreap', sans-serif";
        helpContent.style.fontSize = '16px';
        aboutContent.style.fontFamily = "'Hanuman', 'Khmer OS', 'Siemreap', sans-serif";
        aboutContent.style.fontSize = '16px';
      } else {
        helpContent.style.fontFamily = 'inherit';
        helpContent.style.fontSize = 'inherit';
        aboutContent.style.fontFamily = 'inherit';
        aboutContent.style.fontSize = 'inherit';
      }
      // Do not update langToggle button text here; only update in the event handler
    }

    // Language toggle button
    const langToggleBtn = document.getElementById('langToggle');
    if (langToggleBtn) {
      langToggleBtn.addEventListener('click', () => {
        const newLang = currentLang === 'en' ? 'km' : 'en';
        // Update all language content first (this will also set currentLang and localStorage)
        updateLanguage(newLang);
        // Update button text after
        langToggleBtn.textContent = newLang === 'en' ? 'ğŸŒ ááŸ’á˜áŸ‚áš' : 'ğŸŒ English';
        // Update activation status to refresh activate/deactivate button text
        updateActivationStatus();
      });
    }

    // DOM Elements
    const elText = document.getElementById('qrText');
    const elSize = document.getElementById('qrSize');
    const elEC = document.getElementById('qrEC');
    const elFG = document.getElementById('qrFG');
    const elBG = document.getElementById('qrBG');
    const elDpi = document.getElementById('dpiScale');
    const elLogoBg = document.getElementById('logoBg');
    const elLogoRound = document.getElementById('logoRound');
    const elOverlay = document.getElementById('overlayText');
    const elLogoUpload = document.getElementById('logoUpload');
    const logoUploadBtn = document.getElementById('logoUploadBtn');
    const logoPreview = document.getElementById('logoPreview');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnDownload = document.getElementById('btnDownload');
    const btnClear = document.getElementById('btnClear');
    const btnHelp = document.getElementById('btnHelp');
    const btnAbout = document.getElementById('btnAbout');
    const qrPreview = document.getElementById('qrPreview');

    // Logo file change
    elLogoUpload.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = (event) => {
          logoImage = new Image();
          logoImage.onload = () => {
            // Show preview
            logoPreview.innerHTML = '<img src="' + event.target.result + '" alt="Logo"/><p>Logo selected</p>';
            logoPreview.style.display = 'block';
            console.log('Logo loaded successfully');
          };
          logoImage.onerror = () => {
            alert('Failed to load logo image. Try a different file.');
            logoImage = null;
            logoPreview.style.display = 'none';
            elLogoUpload.value = '';
          };
          logoImage.src = event.target.result;
        };
        
        reader.onerror = () => {
          alert('Failed to read file');
        };
        
        reader.readAsDataURL(file);
      }
    });

    // Generate QR Code
    btnGenerate.addEventListener('click', () => {
      console.log('Generate button clicked!');
      if (!elText.value) {
        alert(translations[currentLang].alertEnterText);
        return;
      }

      try {
        qrPreview.innerHTML = '';
        const size = parseInt(elSize.value);
        const dpi = parseInt(elDpi.value);

        // Create temporary container for QRCode library
        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        tempDiv.id = 'qr-temp-' + Date.now();
        document.body.appendChild(tempDiv);

        // Generate QR code
        const qrInstance = new QRCode(tempDiv, {
          text: elText.value,
          width: size,
          height: size,
          colorDark: elFG.value,
          colorLight: elBG.value,
          correctLevel: QRCode.CorrectLevel[elEC.value]
        });

        // Wait for canvas to be created
        setTimeout(() => {
          try {
            const qrCanvas = tempDiv.querySelector('canvas');
            if (!qrCanvas) {
              throw new Error('Failed to generate QR code');
            }

            // Create preview canvas
            const previewCanvas = document.createElement('canvas');
            const captionHeight = elOverlay.value ? Math.floor(size / 6) : 0;
            previewCanvas.width = size;
            previewCanvas.height = size + captionHeight;
            const ctxPreview = previewCanvas.getContext('2d');

            // Draw background
            ctxPreview.fillStyle = elBG.value;
            ctxPreview.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
            ctxPreview.imageSmoothingEnabled = false;

            // Draw QR code
            ctxPreview.drawImage(qrCanvas, 0, 0, size, size);

            // Draw logo if exists
            if (logoImage) {
              const logoSize = Math.floor(size * 0.25);
              const x = (size - logoSize) / 2;
              const y = (size - logoSize) / 2;
              ctxPreview.fillStyle = elLogoBg.value;

              if (elLogoRound.value === 'yes') {
                ctxPreview.beginPath();
                ctxPreview.arc(x + logoSize / 2, y + logoSize / 2, logoSize / 2, 0, Math.PI * 2);
                ctxPreview.fill();
              } else {
                ctxPreview.fillRect(x, y, logoSize, logoSize);
              }

              ctxPreview.imageSmoothingEnabled = true;
              ctxPreview.drawImage(logoImage, x, y, logoSize, logoSize);
              ctxPreview.imageSmoothingEnabled = false;
            }

            // Draw caption if exists
            if (elOverlay.value) {
              ctxPreview.fillStyle = '#ffffff';
              ctxPreview.fillRect(0, size, size, captionHeight);
              ctxPreview.fillStyle = elFG.value;
              ctxPreview.font = Math.floor(captionHeight * 0.6) + 'px Arial';
              ctxPreview.textAlign = 'center';
              ctxPreview.textBaseline = 'middle';
              ctxPreview.fillText(elOverlay.value, size / 2, size + captionHeight / 2);
            }

            // Display preview
            qrPreview.innerHTML = '';
            qrPreview.appendChild(previewCanvas);

            // Create export canvas for high-quality download
            const exportCanvasEl = document.createElement('canvas');
            exportCanvasEl.width = size * dpi;
            const captionHeightExport = elOverlay.value ? Math.floor(size * dpi / 6) : 0;
            exportCanvasEl.height = size * dpi + captionHeightExport;
            const ctx = exportCanvasEl.getContext('2d');

            // Draw on export canvas
            ctx.fillStyle = elBG.value;
            ctx.fillRect(0, 0, exportCanvasEl.width, exportCanvasEl.height);
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(qrCanvas, 0, 0, size, size, 0, 0, size * dpi, size * dpi);

            if (logoImage) {
              const logoSize = Math.floor(size * 0.25) * dpi;
              const x = Math.floor((size * dpi - logoSize) / 2);
              const y = Math.floor((size * dpi - logoSize) / 2);
              ctx.fillStyle = elLogoBg.value;

              if (elLogoRound.value === 'yes') {
                ctx.beginPath();
                ctx.arc(x + logoSize / 2, y + logoSize / 2, logoSize / 2, 0, Math.PI * 2);
                ctx.fill();
              } else {
                ctx.fillRect(x, y, logoSize, logoSize);
              }

              ctx.imageSmoothingEnabled = true;
              ctx.drawImage(logoImage, x, y, logoSize, logoSize);
              ctx.imageSmoothingEnabled = false;
            }

            if (elOverlay.value) {
              ctx.fillStyle = '#ffffff';
              ctx.fillRect(0, size * dpi, size * dpi, captionHeightExport);
              ctx.fillStyle = elFG.value;
              ctx.font = Math.floor(captionHeightExport * 0.6) + 'px Arial';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(elOverlay.value, size * dpi / 2, size * dpi + captionHeightExport / 2);
            }

            exportCanvas = exportCanvasEl;
            btnDownload.disabled = false;
            btnShare.disabled = false;
            document.body.removeChild(tempDiv);
          } catch (err) {
            console.error('Error:', err);
            alert('Error: ' + err.message);
            if (document.body.contains(tempDiv)) {
              document.body.removeChild(tempDiv);
            }
          }
        }, 100);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });
    // Download QR Code
    const btnShare = document.getElementById('btnShare');
    const downloadMenu = document.getElementById('downloadMenu');
    const shareMenu = document.getElementById('shareMenu');

    // Download format functions
    window.downloadCanvas = function(format) {
      if (!exportCanvas) return;
      
      const isActivated = localStorage.getItem('kmqr_app_activated') === 'true';
      if (!isActivated) {
        // Close the download menu BEFORE showing alert
        const downloadMenu = document.getElementById('downloadMenu');
        if (downloadMenu) downloadMenu.style.display = 'none';
        
        // Use setTimeout to show alert after menu closes
        setTimeout(() => {
          alert(translations[currentLang].alertDownloadLocked);
        }, 100);
        return;
      }
      
      if (format === 'png') {
        const link = document.createElement('a');
        link.download = 'KMQR-' + Date.now() + '.png';
        link.href = exportCanvas.toDataURL('image/png');
        link.click();
      } else if (format === 'jpg') {
        const link = document.createElement('a');
        link.download = 'KMQR-' + Date.now() + '.jpg';
        link.href = exportCanvas.toDataURL('image/jpeg', 0.95);
        link.click();
      } else if (format === 'pdf') {
        downloadAsPDF();
      }
      const downloadMenu = document.getElementById('downloadMenu');
      if (downloadMenu) downloadMenu.style.display = 'none';
    };

    window.downloadAsPDF = function() {
      try {
        var canvas = exportCanvas;
        if (!canvas) {
          alert('Please generate a QR code first');
          return;
        }
        
        // Convert canvas to PNG image data
        var imgData = canvas.toDataURL('image/png');
        
        // Open in new browser tab/window so user can save as PDF
        var newWindow = window.open();
        if (newWindow) {
          newWindow.document.write('<html><body style="margin:0; padding:20px; background:#f0f0f0; text-align:center;">');
          newWindow.document.write('<h2 style="color:#333;">KMQR Generator - QR Code</h2>');
          newWindow.document.write('<img src="' + imgData + '" style="max-width:600px; max-height:600px; border:2px solid #333; padding:20px; background:white; margin:20px auto; display:block; border-radius:8px;">');
          newWindow.document.write('<p style="color:#666; margin-top:20px;">Right-click image to save, or use Ctrl+P to print as PDF</p>');
          newWindow.document.write('<p style="color:#999; font-size:12px;">Tip: When printing, select "Save as PDF" from printer dropdown</p>');
          newWindow.document.write('</body></html>');
          newWindow.document.close();
          newWindow.document.title = 'KMQR-' + Date.now() + '.pdf';
        } else {
          alert('Could not open new window. Check browser popup settings.');
        }
      } catch (err) {
        console.error('PDF export error:', err);
        alert('Error: ' + err.message);
      }
    };

    document.getElementById('downloadPNG').addEventListener('click', () => downloadCanvas('png'));
    document.getElementById('downloadJPG').addEventListener('click', () => downloadCanvas('jpg'));
    document.getElementById('downloadPDF').addEventListener('click', () => downloadCanvas('pdf'));

    // Social sharing functions
    function getQRDataURL() {
      return exportCanvas ? exportCanvas.toDataURL('image/png') : null;
    }

    window.shareToSocial = function(platform) {
      const elText = document.getElementById('qrText');
      const shareMenu = document.getElementById('shareMenu');
      
      if (!elText.value) {
        alert('Please generate a QR code first');
        return;
      }

      const text = encodeURIComponent('Check out my QR code created with KMQR Generator: ' + elText.value);
      const url = 'https://kmqr.com'; // Your website
      
      let shareUrl = '';
      
      switch(platform) {
        case 'whatsapp':
          shareUrl = 'https://wa.me/?text=' + text;
          break;
        case 'facebook':
          shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url) + '&quote=' + text;
          break;
        case 'twitter':
          shareUrl = 'https://twitter.com/intent/tweet?text=' + text + '&url=' + encodeURIComponent(url);
          break;
        case 'telegram':
          shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + text;
          break;
        case 'email':
          window.location.href = 'mailto:?subject=Check My QR Code&body=' + encodeURIComponent('QR Text: ' + elText.value + '\n\nCreated with KMQR Generator\nhttps://facebook.com/KMLOL');
          if (shareMenu) shareMenu.style.display = 'none';
          return;
        case 'copy':
          navigator.clipboard.writeText(elText.value).then(() => {
            alert('QR code data copied to clipboard!');
          }).catch(() => {
            alert('Could not copy to clipboard');
          });
          if (shareMenu) shareMenu.style.display = 'none';
          return;
      }
      
      if (shareUrl) {
        window.open(shareUrl, '_blank');
        if (shareMenu) shareMenu.style.display = 'none';
      }
    };

    document.getElementById('shareWhatsApp').addEventListener('click', () => shareToSocial('whatsapp'));
    document.getElementById('shareFacebook').addEventListener('click', () => shareToSocial('facebook'));
    document.getElementById('shareTwitter').addEventListener('click', () => shareToSocial('twitter'));
    document.getElementById('shareTelegram').addEventListener('click', () => shareToSocial('telegram'));
    document.getElementById('shareEmail').addEventListener('click', () => shareToSocial('email'));
    document.getElementById('shareCopy').addEventListener('click', () => shareToSocial('copy'));

    // Clear all
    btnClear.addEventListener('click', () => {
      qrPreview.innerHTML = '<p id="previewHint">' + translations[currentLang].previewHint + '</p>';
      elText.value = '';
      elOverlay.value = '';
      elLogoUpload.value = '';
      logoImage = null;
      logoPreview.style.display = 'none';
      exportCanvas = null;
      btnDownload.disabled = true;
      btnShare.disabled = true;
      downloadMenu.style.display = 'none';
      shareMenu.style.display = 'none';
    });

    // Help and About modals
    btnHelp.addEventListener('click', () => {
      document.getElementById('helpModal').classList.add('active');
    });

    btnAbout.addEventListener('click', () => {
      document.getElementById('aboutModal').classList.add('active');
    });

    window.closeModal = function(id) {
      const modal = document.getElementById(id);
      if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
      }
    };

    // Close modals on background click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
          modal.style.display = 'none';
        }
      });
    });

    // Close modals on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          modal.classList.remove('active');
          modal.style.display = 'none';
        });
      }
    });

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#btnDownload') && !e.target.closest('#downloadMenu')) {
        const downloadMenu = document.getElementById('downloadMenu');
        if (downloadMenu) downloadMenu.style.display = 'none';
      }
      if (!e.target.closest('#btnShare') && !e.target.closest('#shareMenu')) {
        const shareMenu = document.getElementById('shareMenu');
        if (shareMenu) shareMenu.style.display = 'none';
      }
    });

    // Initialize
    updateLanguage(currentLang);
    updateActivationStatus();
    initializeLicense();
    initializeWelcome();
  </script>
</body>
</html>
